# 安全资源分享网 - 支付系统架构概览

## 🏗️ 系统架构

```
┌────────────────────────────────────────────────────────────────┐
│                        用户应用层 (Browser)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │  首页        │  │  资源库      │  │  充值页面    │          │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘          │
└─────────┼──────────────────┼─────────────────┼─────────────────┘
          │                  │                 │
          ▼                  ▼                 ▼
┌────────────────────────────────────────────────────────────────┐
│                  应用服务层 (Next.js API Routes)               │
│  ┌────────────────────┐         ┌──────────────────────┐       │
│  │ app/api/resources  │         │ app/api/payments     │       │
│  │  /route.ts         │         │  /initiate/route.ts  │       │
│  └────────────────────┘         │  /callback/route.ts  │       │
│                                 │  /status/route.ts    │       │
│                                 └──────────────────────┘       │
└────────────────────────────────────────────────────────────────┘
          │                                       │
          └───────────────┬──────────────────────┘
                          │
          ┌───────────────┴───────────────┐
          ▼                               ▼
┌──────────────────────┐      ┌──────────────────────┐
│  业务逻辑层          │      │  支付客户端          │
│  (lib/auth.ts)       │      │  (lib/pingpp.ts)     │
│  (lib/prisma)        │      │                      │
│                      │      │  ✅ createCharge()   │
│                      │      │  ✅ queryCharge()    │
└──────────────────────┘      │  ✅ refund()         │
          │                   │  ✅ verifySignature()│
          └───────────────────┴──────────────────────┘
                        │
          ┌─────────────┴──────────────┐
          ▼                            ▼
┌──────────────────────┐      ┌──────────────────────┐
│  PostgreSQL 数据库   │      │  Ping++ 支付网关     │
│                      │      │                      │
│  ✅ users            │      │  ✅ 微信支付         │
│  ✅ categories       │      │  ✅ 支付宝           │
│  ✅ resources        │      │  ✅ 银行卡           │
│  ✅ payments         │      │  ✅ Webhook 回调     │
│  ✅ downloads        │      │                      │
└──────────────────────┘      └──────────────────────┘
          ▲                            ▲
          │                            │
          └────────────────┬───────────┘
                           │
                    数据同步层
```

---

## 📊 数据流图

### 支付流程

```
┌─────────────────────────────────────────────────────────────────┐
│                      1. 支付初始化                              │
└─────────────────────────────────────────────────────────────────┘

用户选择积分 + 支付方式
    │
    ▼
POST /api/payments/initiate
    │
    ├─ 验证 JWT Token
    ├─ 验证参数完整性
    └─ 生成订单 ID (TXN_timestamp_random)
        │
        ▼
    ┌─────────────────────────────────┐
    │ 检查 Ping++ 配置?               │
    └─┬───────────────────────────┬───┘
      │                           │
   有 ✅                         否 ❌
      │                           │
      ▼                           ▼
  调用 Ping++ API          返回模拟二维码
  createCharge()              (开发模式)
      │
      ▼
  获取支付 ID + 二维码
      │
      ▼
  保存支付记录到数据库
  status = "pending"
      │
      ▼
  返回给前端显示二维码


┌─────────────────────────────────────────────────────────────────┐
│                      2. 用户支付                                │
└─────────────────────────────────────────────────────────────────┘

用户扫码 → 支付宝/微信 → 完成支付
                        │
                        ▼
                  Ping++ 接收支付


┌─────────────────────────────────────────────────────────────────┐
│                      3. Webhook 回调处理                        │
└─────────────────────────────────────────────────────────────────┘

Ping++ → POST /api/payments/callback
              │
              ├─ 验证 Webhook 签名
              │
              ▼
          签名有效?
          │
          ├─ 否 → 返回 403
          │
          └─ 是 → 解析事件类型
                    │
                    ├─ charge.succeeded
                    │   │
                    │   ▼
                    │  查询支付记录
                    │   │
                    │   ├─ 未找到 → 返回 404
                    │   │
                    │   ├─ 已处理 → 返回 200 (幂等性)
                    │   │
                    │   └─ 待处理 → 处理支付
                    │       │
                    │       ├─ 更新支付状态 = "completed"
                    │       ├─ 查询用户当前积分
                    │       ├─ 增加积分
                    │       └─ 返回 200
                    │
                    ├─ charge.failed
                    │   │
                    │   ▼
                    │  更新支付状态 = "failed"
                    │  返回 200
                    │
                    └─ refund.succeeded
                        │
                        ▼
                       计算应扣积分
                       扣除用户积分
                       返回 200
```

### 数据模型关系

```
Users (用户)
  ├─ id (PK)
  ├─ email (unique)
  ├─ password (hashed)
  ├─ points (当前积分)
  ├─ createdAt
  └─ updatedAt
         │
         ├─ 1:N ──────────────────┐
         │                        │
         │                        ▼
         │               Downloads (下载记录)
         │                  ├─ id
         │                  ├─ userId (FK)
         │                  ├─ resourceId (FK)
         │                  ├─ pointsUsed
         │                  └─ createdAt
         │
         └─ 1:N ──────────────────┐
                                  │
                                  ▼
                          Payments (支付记录)
                             ├─ id
                             ├─ userId (FK)
                             ├─ amount
                             ├─ pointsAdded
                             ├─ paymentMethod
                             ├─ status
                             ├─ transactionId (unique)
                             ├─ createdAt
                             └─ updatedAt

Resources (资源)
  ├─ id (PK)
  ├─ title
  ├─ categoryId (FK)
  ├─ description
  ├─ mainLink
  ├─ password
  ├─ backupLink1
  ├─ backupLink2
  ├─ source
  ├─ pointsCost
  ├─ downloads (计数)
  └─ createdAt
         │
         └─ N:1
              │
              ▼
          Categories (分类)
             ├─ id
             ├─ name (unique)
             ├─ pointsCost
             ├─ description
             └─ createdAt
```

---

## 🔐 安全架构

```
┌─────────────────────────────────────────────────────────┐
│                    HTTPS 层 (TLS/SSL)                   │
└─────────────────────────────────────────────────────────┘
              ▲                               ▲
              │                               │
    ┌─────────┴──────────┐        ┌──────────┴────────────┐
    │ 用户浏览器         │        │ Ping++ 服务器         │
    │ (客户端)           │        │ (第三方支付)          │
    └────────────────────┘        └──────────────────────┘
              │                               │
              │ JWT Token                    │ HMAC-SHA256
              │ (身份验证)                   │ (签名验证)
              │                               │
              ▼                               ▼
    ┌─────────────────────────────────────────────────────┐
    │                  应用服务器                          │
    │  ┌────────────────────────────────────────────────┐ │
    │  │ 1. JWT 验证                                    │ │
    │  │    - 检查 Token 有效性                         │ │
    │  │    - 验证签名和过期时间                       │ │
    │  │                                                │ │
    │  │ 2. 请求验证                                   │ │
    │  │    - 参数检查                                 │ │
    │  │    - 金额范围验证                             │ │
    │  │    - 支付方式验证                             │ │
    │  │                                                │ │
    │  │ 3. Webhook 验证                               │ │
    │  │    - HMAC-SHA256 签名验证                     │ │
    │  │    - 事件类型检查                             │ │
    │  │                                                │ │
    │  │ 4. 幂等性控制                                 │ │
    │  │    - 检查重复处理                             │ │
    │  │    - 事务隔离                                 │ │
    │  │                                                │ │
    │  │ 5. 日志和审计                                 │ │
    │  │    - 记录所有支付操作                         │ │
    │  │    - 追踪异常情况                             │ │
    │  └────────────────────────────────────────────────┘ │
    └─────────────────────────────────────────────────────┘
              │
              ▼
    ┌─────────────────────────────────────────────────────┐
    │              PostgreSQL 数据库                       │
    │  ✅ 密码哈希存储 (bcryptjs)                         │
    │  ✅ 事务处理 (ACID)                                │
    │  ✅ 连接池保护                                     │
    └─────────────────────────────────────────────────────┘
```

---

## 🚀 部署架构

```
┌──────────────────────────────────────────────────────────────┐
│                     GitHub Repository                        │
│  https://github.com/lgd3206/anquanwang                      │
└──────────────────┬───────────────────────────────────────────┘
                   │ (Git Push)
                   ▼
┌──────────────────────────────────────────────────────────────┐
│                  Vercel Platform                             │
│  ┌─────────────────────────────────────────────────────────┐ │
│  │ 1. Build Phase (CI/CD)                                  │ │
│  │    npm install → npm run build → prisma generate        │ │
│  │                                                         │ │
│  │ 2. Environment Variables                               │ │
│  │    DATABASE_URL                                        │ │
│  │    PING_APP_ID                                         │ │
│  │    PING_API_KEY                                        │ │
│  │    PING_WEBHOOK_KEY                                    │ │
│  │                                                         │ │
│  │ 3. Serverless Deployment                              │ │
│  │    Next.js API Routes → AWS Lambda Functions          │ │
│  │    Static Assets → Vercel Edge Network                │ │
│  │                                                         │ │
│  │ 4. Auto Scaling                                        │ │
│  │    按需自动扩展                                        │ │
│  └─────────────────────────────────────────────────────────┘ │
└──────────────────┬───────────────────────────────────────────┘
                   │
      ┌────────────┼────────────┐
      ▼            ▼            ▼
┌───────────┐ ┌──────────┐ ┌──────────────┐
│ Neon 数据 │ │ Ping++   │ │ Custom Domain│
│ 库        │ │ API 网关 │ │ (DNS)        │
└───────────┘ └──────────┘ └──────────────┘
```

---

## 📈 可扩展性考虑

### 现在 (单体架构)
```
Single Vercel Deployment
    ↓
Single Neon PostgreSQL Database
    ↓
Direct Ping++ Integration
```

### 未来 (微服务架构)
```
API Gateway (负载均衡)
    │
    ├─ Payment Service (支付服务)
    ├─ Resource Service (资源服务)
    ├─ User Service (用户服务)
    └─ Download Service (下载服务)
        │
        ├─ PostgreSQL Primary (主库写)
        ├─ PostgreSQL Replica (从库读)
        └─ Redis Cache (缓存)
```

---

## 🎯 关键指标监控

```
支付系统关键指标 (KPIs)
│
├─ 成功率 (Success Rate)
│  └─ 目标: > 99%
│
├─ 处理时间 (Processing Time)
│  └─ 目标: < 1 秒
│
├─ Webhook 可靠性 (Webhook Reliability)
│  └─ 目标: 100% 接收
│
├─ 用户转化率 (Conversion Rate)
│  └─ 目标: 逐月提升
│
└─ 平均订单金额 (AOV - Average Order Value)
   └─ 监控用户充值金额分布
```

---

## 📚 文档导航

| 文档 | 用途 | 读者 |
|------|------|------|
| `PINGPP_INTEGRATION.md` | 完整集成指南 | 开发人员 |
| `PINGPP_SETUP_GUIDE.md` | 快速开始和FAQ | 所有人 |
| `PRODUCTION_CHECKLIST.md` | 生产部署清单 | 运维人员 |
| `IMPLEMENTATION_SUMMARY.md` | 实现总结报告 | 项目经理 |
| 本文档 | 系统架构概览 | 架构师 |

---

## 🔄 技术栈总结

| 层级 | 技术 | 用途 |
|------|------|------|
| **前端** | React 19 + TypeScript | UI 组件 |
| **框架** | Next.js 16 | 全栈框架 |
| **样式** | Tailwind CSS v4 | UI 样式 |
| **后端** | Node.js (Serverless) | API 服务 |
| **ORM** | Prisma v5 | 数据库访问 |
| **数据库** | PostgreSQL (Neon) | 数据存储 |
| **支付** | Ping++ API | 聚合支付 |
| **认证** | JWT + bcryptjs | 用户认证 |
| **部署** | Vercel | 云平台 |
| **版本控制** | GitHub | 代码管理 |

---

**图表版本:** 1.0
**最后更新:** 2025-12-11
**维护者:** 安全资源分享网开发团队
